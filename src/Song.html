<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Now Playing</title>
    <link rel="stylesheet" href="TrackStyle.css">
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"
            integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
    <script>
        const refreshRate = 500;

        const animationDuration = 500;

        let isPlaying = false;

        let isNewTrack = true;
        let trackId = "";

        let track = "";

        let isNewAlbum = true;
        let album = "";

        let isNewArtist = true;
        let artist = "";

        function updateTrackId() {
            return $.get("Snip_TrackId.txt", function (newTrackId) {
                isNewTrack = trackId !== newTrackId;

                trackId = newTrackId;

                isPlaying = !!trackId;
            }.bind(this));
        }

        function updateArtist() {
            return $.get("Snip_Artist.txt", function (newArtist) {
                newArtist = newArtist.replace(/&/g, "&amp;");

                isNewArtist = newArtist !== artist;

                artist = newArtist || artist;
            }.bind(this));
        }

        function updateTrack() {
            return $.get("Snip_Track.txt", function (newTrack) {
                newTrack = newTrack.replace(/&/g, "&amp;");

                isNewTrack = newTrack !== track;

                track = newTrack || track;
            }.bind(this));
        }

        function showArtist() {
            $("#artist").removeClass("hide");
        }

        function hideArtist() {
            $("#artist").addClass("hide");
        }

        function refreshArtistDisplay() {
            if (isNewArtist)
                hideArtist();

            setTimeout(function () {
                $("#artist").html(artist);

                const isArtistTooWide = $("#artist").outerWidth() > containerWidth;

                if (isArtistTooWide)
                    $("#artist").addClass("marquee");
                else
                    $("#artist").removeClass("marquee");

                if (isPlaying)
                    showArtist();
            }.bind(this), animationDuration);
        }

        function hideTrack() {
            $("#track").addClass("hide");
        }

        function showTrack() {
            $("#track").removeClass("hide");
        }

        function refreshTrackDisplay() {
            if (!isNewTrack)
                return;

            hideTrack();

            setTimeout(function () {
                $("#track").html(track);

                const isTrackTooWide = $("#track").outerWidth() > containerWidth;

                if (isTrackTooWide)
                    $("#track").addClass("marquee");
                else
                    $("#track").removeClass("marquee");

                if (isPlaying)
                    showTrack();
            }.bind(this), animationDuration);
        }

        function refreshAlbumDisplay() {
            if (isPlaying && isNewAlbum)
                hideArtwork();

            setTimeout(function () {
                const path = "Snip_Artwork.jpg?t=" + track + artist;

                $("#artwork").prop("src", path);

                if (isPlaying && isNewAlbum)
                    showArtwork();
            }, animationDuration);
        }

        function showArtwork() {
            $("#artwork").removeClass("hide");

            setTimeout(function () {
                $("#artwork").addClass("animate");
            }, animationDuration);
        }

        function hideArtwork() {
            $("#artwork").addClass("hide");

            setTimeout(function () {
                $("#artwork").removeClass("animate");
            }, animationDuration);
        }

        function showAll() {
            $("#now-playing-container, #track-artist-container").removeClass("hide");

            setTimeout(function () {
                showArtwork();
                showTrack();
                showArtist();
            }, animationDuration);
        }

        function hideAll() {
            hideArtwork();
            hideTrack();
            hideArtist();

            setTimeout(function () {
                $("#now-playing-container, #track-artist-container").addClass("hide");
            }, animationDuration);
        }

        function updateAlbum() {
            return $.get("Snip_Album.txt", function (newAlbum) {
                newAlbum = newAlbum.replace(/&/g, "&amp;");

                isNewAlbum = newAlbum !== album;

                album = newAlbum;
            }.bind(this));
        }

        function checkNowPlaying() {
            updateTrackId().then(function () {
                if (isPlaying && isNewTrack) {
                    updateArtist().then(function () {
                        updateTrack().then(function () {
                            updateAlbum().then(function () {
                                showAll();

                                setTimeout(function () {
                                    refreshAlbumDisplay();
                                    refreshTrackDisplay();
                                    refreshArtistDisplay();

                                    checkNowPlaying();
                                }.bind(this), animationDuration);
                            }.bind(this));
                        }.bind(this));
                    }.bind(this));
                } else if (!isPlaying) {
                    hideAll();

                    setTimeout(checkNowPlaying.bind(this), refreshRate);
                } else {
                    setTimeout(checkNowPlaying.bind(this), refreshRate);
                }
            }.bind(this));
        }

        let containerWidth = 0;

        $(document).ready(function () {
            containerWidth = $("#track-artist-container").width() - 8;

            checkNowPlaying();
        });
    </script>
</head>
<body>
<div id="now-playing-container">
    <div id="artwork-container">
        <img id=artwork class="hide">
    </div>
    <div id="track-artist-container" class="hide">
        <div id=track class="hide"></div>
        <br>
        <div id=artist class="hide"></div>
    </div>
</div>
</body>
</html>