<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Now Playing</title>
    <link rel="stylesheet" href="TrackStyle.css">
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"
            integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
    <script>
        const refreshRate = 500;

        const animationDuration = 500;

        let isPlaying = false;

        let isNewAlbum = true;
        let isNewTrack = true;
        let isNewArtist = true;

        let trackId = "";
        let track = "";
        let album = "";
        let artist = "";

        function checkIfTrackHasChanged() {
            return $.get("Snip_TrackId.txt", function (newTrackId) {
                newTrackId = newTrackId.replace(/&/g, "&amp;");

                isNewTrack = trackId !== newTrackId;

                trackId = newTrackId;

                isPlaying = !!trackId;
            }.bind(this));
        }

        function getNowPlaying() {
            return $.get("Snip_Metadata.json", function (data) {
                data = data.item || data;

                let newTrack = data.name.replace(/&/g, "&amp;");
                let newAlbum = data.album.name.replace(/&/g, "&amp;");
                let newArtist = buildArtistDisplay(data.artists).replace(/&/g, "&amp;");

                isNewAlbum = album !== newAlbum;
                isNewArtist = artist !== newArtist;

                album = newAlbum;
                track = newTrack;
                artist = newArtist;
            }.bind(this));
        }

        function buildArtistDisplay(artistArray) {
            let newArtist = "";

            for (let i = 0; i < artistArray.length; i++) {
                newArtist += artistArray[i].name + ", ";
            }

            newArtist = newArtist.substr(0, newArtist.length - 2);

            return newArtist;
        }

        function showArtist() {
            $("#artist").removeClass("hide");
        }

        function hideArtist() {
            $("#artist").addClass("hide");
        }

        function refreshArtistDisplay() {
            if (isNewArtist)
                hideArtist();

            setTimeout(function () {
                $("#artist").html(artist);

                const isArtistTooWide = $("#artist").outerWidth() > containerWidth;

                if (isArtistTooWide)
                    $("#artist").addClass("marquee");
                else
                    $("#artist").removeClass("marquee");

                if (isPlaying)
                    showArtist();
            }.bind(this), animationDuration);
        }

        function showTrack() {
            $("#track").removeClass("hide");
        }

        function hideTrack() {
            $("#track").addClass("hide");
        }

        function refreshTrackDisplay() {
            if (!isNewTrack)
                return;

            hideTrack();

            setTimeout(function () {
                $("#track").html(track);

                const isTrackTooWide = $("#track").outerWidth() > containerWidth;

                if (isTrackTooWide)
                    $("#track").addClass("marquee");
                else
                    $("#track").removeClass("marquee");

                if (isPlaying)
                    showTrack();
            }.bind(this), animationDuration);
        }

        function showArtwork() {
            $("#artwork").removeClass("hide");

            setTimeout(function () {
                $("#artwork").addClass("animate");
            }, animationDuration);
        }

        function hideArtwork() {
            $("#artwork").addClass("hide");

            setTimeout(function () {
                $("#artwork").removeClass("animate");
            }, animationDuration);
        }

        function refreshArtworkDisplay() {
            if (isPlaying && isNewAlbum)
                hideArtwork();

            setTimeout(function () {
                const path = "Snip_Artwork.jpg?" + Date.now();

                $("#artwork").prop("src", path);

                if (isPlaying && isNewAlbum)
                    showArtwork();
            }, animationDuration);
        }

        function showAll() {
            $("#now-playing-container, #track-artist-container").removeClass("hide");

            setTimeout(function () {
                showArtwork();
                showTrack();
                showArtist();
            }, animationDuration);
        }

        function hideAll() {
            hideArtwork();
            hideTrack();
            hideArtist();

            setTimeout(function () {
                $("#now-playing-container, #track-artist-container").addClass("hide");
            }, animationDuration);
        }

        function checkNowPlaying() {
            checkIfTrackHasChanged().then(function () {
                if (isPlaying && isNewTrack) {
                    getNowPlaying().then(function () {
                        showAll();

                        setTimeout(function () {
                            refreshArtworkDisplay();
                            refreshTrackDisplay();
                            refreshArtistDisplay();

                            checkNowPlaying();
                        }.bind(this), animationDuration);
                    }.bind(this));
                } else if (!isPlaying) {
                    hideAll();

                    setTimeout(checkNowPlaying.bind(this), refreshRate);
                } else {
                    setTimeout(checkNowPlaying.bind(this), refreshRate);
                }
            }.bind(this));
        }

        let containerWidth = 0;

        $(document).ready(function () {
            containerWidth = $("#track-artist-container").width() - 8;

            checkNowPlaying();
        });
    </script>
</head>
<body>
<div id="now-playing-container">
    <div id="artwork-container">
        <img id=artwork class="hide">
    </div>
    <div id="track-artist-container" class="hide">
        <div id=track class="hide"></div>
        <br>
        <div id=artist class="hide"></div>
    </div>
</div>
</body>
</html>